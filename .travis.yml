language: java
os: linux
dist: focal
jdk:
  - openjdk8
  - oraclejdk8
  - openjdk10
  - openjdk11
services:
  - docker

# https://docs.travis-ci.com/user/conditional-builds-stages-jobs/#conditional-builds
if: (branch = master) OR (branch = "/^deployed-\\d+\\.\\d+(\\.\\d+)?(-\\S*)?$/") OR type = pull_request # build whitelisted branches and all PRs

git:
  submodules: false
env:
  global:
    - NODE_VERSION=$(cat rest-e2e-tests/.nvmrc)
    - OWNER=streamr
    - IMAGE_NAME=engine-and-editor
before_install:
  - curl -s http://get.sdkman.io | bash
  - echo sdkman_auto_answer=true > ~/.sdkman/etc/config
  - source "/home/travis/.sdkman/bin/sdkman-init.sh"
  - sdk install grails 2.5.6
  - nvm install $NODE_VERSION
import:
 - source: streamr-dev/travis-ci:docker-secrets.yml@master
jobs:
  include:
    - name: Unit tests
      script: grails test-app -unit
    - name: Validate Swagger
      script: .travis_scripts/validate_swagger.sh
    - name: Integration tests
      script: .travis_scripts/integration_test.sh
    - name: REST API tests
      script: .travis_scripts/rest_e2e_test.sh
after_failure:
  - docker ps
  - .travis_scripts/after_test_failure.sh
  - docker logs streamr-dev-nginx
