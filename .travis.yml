language: groovy
os: linux
dist: xenial
jdk:
- openjdk8
services:
- docker
if: (branch = master) OR type = pull_request # build whitelisted branches and all PRs
git:
  submodules: false
before_install:
- curl -s http://get.sdkman.io | bash
- echo sdkman_auto_answer=true > ~/.sdkman/etc/config
- source "/home/travis/.sdkman/bin/sdkman-init.sh"
- sdk install grails 2.5.6
- nvm install $NODE_VERSION
env:
  global:
  - NODE_VERSION=$(cat rest-e2e-tests/.nvmrc)
  - OWNER=streamr
  - IMAGE_NAME=engine-and-editor
  - secure: Icz6PgvdiMvqiC1yMBknaSMqHvvthOo0hUrVCTGA8pWXaqofX5fKNVI8GL4kvRK7a+YpEZ7SCvHH1cgEfBx8jC+Wc0XjGfBZXH1C1gyo8X1keCcJQVRyhxXkrjaeOLF0Cas8m9MdgAqJlwDcAXkWh426kvpAbU1SbNkkSCX3Ksp6M43LVUEbtkdOCf0GxavfgsGL5S9fk7WUf7hU4+HqL/UbbM+XMTz9hgajI5zzyRPiFwMPLGohNfopLKZvRWL/2IDY4ldVEzRi8koxIYrhO68o5RJJsptw+Gfaf3mzmgDGP9jU/cWYxsrfWogtVGFOiB2nDA+opbDU79vwHCpP5dcZJUEDvgOMVA0aTRT6Mc6hXM07wiL9noJwrSqoudkXianDDJqCKja+myKNi4wVWpisZV0HfF3nWeiKoxBaQdlCc7UUadS4OYK30Xll/Z9Z3ebWWGRmdKRSeD+QmM4j8VMu/t624AX/Q0laAS7/6BKOjMaDUqm3Q7plNWTSQWRmVUFzaH0xRL1DPLIbz/8Z8D1IVOfnq6k2FYTtVnjKQdHH65ddtqZMwtsSJsS9fQRYOm3ly0avPvDNnNeEYEuhY5lF8Tiw1lwh+BHOhiQLAPi7dqTiV/I2ImgdFH6a8wr/KICSquaSRWzwWnod3Jstrz9WWQW+K9JKu4deIRUOEx4=
  - secure: Ro0tLYzPfBquDume3DCVOBcwGQtnkDCsitIteCjoiA75epYyweTN4pdaVdmI+nM41mKlXhbo6MYPukOVlxC0DqERsbAbQH8LKuJi+Ylio27ueC8pC0eDS+HjBu0OYLRzNuuhYalHRjAIZFI67CD1CHwFmbws6mENfte5L0sWdieOfnAmM74/82+ZpAibCC1FlIu4qLJxmHSYmH8bC5ZmNTQ59yx2h2BmsXdpJ5b2AVnoevnY8fxSb7mYC98tfS9x979+CMth510v5MzQR4AhwhmnaBcm7wjDgyINVcCG3YSQIs9nhP+AOOi8p+WCibCHGwU9uCPiDBy9KZvNppG7Wpw2JhKVSKOQvZsaxy6tarPxXEFXwaZjLbFw4aUVTe/aPsiOq+LZCljlSNFHANwVpAFqpxtUip2nap9156XNueegWDsgHHkmvp17bHRgsbk+KXvNuD2ieCiuMBJPXSKjm/6oyYsqFc9sPo/0jficsQWkegPkbBZu13acniqRZHENN91SyIh/OfZJQ5hapd8eaPS68iBVseVjplMXbaoId2PMuLw9BF1RXkc/LXHP6mN3DzrILdlezcHzdd87zJseY9+GIgEnihqvhXa53LGEB3KHe22mX0zuw7pOpaxWE89N/mSQFVehh/nnU20lylsiWpXWHe/B9vjMlmk8FnBvjuI=
jobs:
  include:
  - stage: Unit tests
    script: grails test-app -unit
  - stage: Validate Swagger
    script: travis_retry .travis_scripts/validate_swagger.sh
  - stage: Integration tests
    script: travis_retry .travis_scripts/integration_test.sh
  - stage: REST API tests
    script: .travis_scripts/rest_e2e_test.sh
  - stage: Build war Staging
    script: .travis_scripts/build_war.sh
    env:
    - WS_URL="wss://ee-staging.streamr.com/api/v1/ws"
    deploy:
    - provider: s3
      access_key_id: AKIAI3FGPGMK3EREJJTQ
      secret_access_key:
        secure: VHz9wZb/IuYsfVko6q5zUzkfg2Impn9wrhfWJB5KQtHu73eozlbd6okkwl324dwS6TwB/oo7PdVyQL4ugLGvGlgbN6T4z/5KwQ/roS/z6ycKHIspeFZiiU7TYPTboOwOhWhV0ze+FmQD/E8I49J6mTOkwW2Y0rHA5awMQHz5LSWsF5heTlo3NAeQO2ynPW+Ely6HNoSP39a/d84gUJ+VTlkIivoQr7QwEe0JWrpvncMVkGvTinH+2oWeLwAkRFD2e9tu8jr9f182JfA0m6SHCJaCTp0e+3Uv4BQZ2NM/xtMgjjBDBvCZG4ZbO06+U2NwPe2nI4IQBj/23NXdTn1D4O1/7xYzk1H/mSzOYNFe7ATpfp7fOanJI6TB0Hq+jY+xHrQcD66sPPJPg8qkf8TuDRpsQqWVbHxmfQT0L3pDFajwG18kwtJ3LBwynwDcsZeGpAWQLXKYvVRVGDbKb+sZBq/qJKjDc0lJ0C/Ml6MNbJS8OP8b68nP6/sJ/N3Hbb9MQu+xhei3FCCrWqarE7fgpWT+oTHjNEC1ceUUMV+2rEb5fskSwipchHVADrIAqtiUPvNiKMp4Iom306OfmljBR85pA238AHGy1X7DOfEM0hSg9FkWWxZI/4d2GL+wfk5bhVVwlnFUrd4azco5l7W172I97PhpMqcRnaHrzpvGvj4=
      bucket: eu-west-1-stg-streamr-vault
      upload-dir: engine-editor/releases
      acl: private
      region: eu-west-1
      skip_cleanup: true
      local_dir: build
      on:
        branch: master
    - provider: codedeploy
      access_key_id: AKIAI3FGPGMK3EREJJTQ
      secret_access_key:
        secure: VHz9wZb/IuYsfVko6q5zUzkfg2Impn9wrhfWJB5KQtHu73eozlbd6okkwl324dwS6TwB/oo7PdVyQL4ugLGvGlgbN6T4z/5KwQ/roS/z6ycKHIspeFZiiU7TYPTboOwOhWhV0ze+FmQD/E8I49J6mTOkwW2Y0rHA5awMQHz5LSWsF5heTlo3NAeQO2ynPW+Ely6HNoSP39a/d84gUJ+VTlkIivoQr7QwEe0JWrpvncMVkGvTinH+2oWeLwAkRFD2e9tu8jr9f182JfA0m6SHCJaCTp0e+3Uv4BQZ2NM/xtMgjjBDBvCZG4ZbO06+U2NwPe2nI4IQBj/23NXdTn1D4O1/7xYzk1H/mSzOYNFe7ATpfp7fOanJI6TB0Hq+jY+xHrQcD66sPPJPg8qkf8TuDRpsQqWVbHxmfQT0L3pDFajwG18kwtJ3LBwynwDcsZeGpAWQLXKYvVRVGDbKb+sZBq/qJKjDc0lJ0C/Ml6MNbJS8OP8b68nP6/sJ/N3Hbb9MQu+xhei3FCCrWqarE7fgpWT+oTHjNEC1ceUUMV+2rEb5fskSwipchHVADrIAqtiUPvNiKMp4Iom306OfmljBR85pA238AHGy1X7DOfEM0hSg9FkWWxZI/4d2GL+wfk5bhVVwlnFUrd4azco5l7W172I97PhpMqcRnaHrzpvGvj4=
      bucket: eu-west-1-stg-streamr-vault
      key: engine-editor/releases/ee-${TRAVIS_JOB_ID}.tar
      application: eu-west-1-stg-ee-codedeploy
      deployment_group: eu-west-1-stg-ee-deployment-group
      region: eu-west-1
      on:
        branch: master
    if: NOT type IN (pull_request)
  - stage: Build Docker Dev/Nightly
    if: tag IS blank
    install: true
    script:
    - grails test war
    - docker build -t $OWNER/$IMAGE_NAME:local .
    - .travis_scripts/smoke_test.sh
    deploy:
    - provider: script
      script: .travis_scripts/deploy_docker.sh dev
  - stage: Deploy Swagger file
    if: tag IS present
    deploy:
    - provider: s3
      access_key_id: AKIAI3FDTJG3O6WWN4BQ
      secret_access_key:
        secure: "mJtZqcGrs8bTJKEaV/VkUfcVTT4y+U1s6hztF45diTDQpT0uleLXClO8ljj3S0mbN3r+ykLBRvSohOOki94+v8z9/VDptVyrFUNEah2PKl30D3S74LeRXN/3xK25h6Y9HLdcbTuhlY988sQGONztkpS7kQCnaDa38rB0eUXfqhBC6WRJpmVmp1T0OSReZM7Et8VFfzcjudxQDT3YuYAvSd3MNpgfq6YXRdetzB0Tou8PtdyO02C87JANw9+BYxgaEcNtVIAtkEHyFriOdkqeo9c0zBJJbU/B6FxC/XZL6PfakZnVTuNEHjDuOvPhjMHKg1yWuCLhWchY9aZ3tbm9A7QG0cVycb/dwGeyNCwwocjPRMKell+2a749sYvP5WqNjYD+0wZp54WCglzTOxXy2EzX4UJZ6EeDzMOEJJ/Z/BnTZaRk9PiaH8iCSLOPqZ9uQV9ZV4+HliQYg/6yV33gT1PjjV6B80omYdrzu5kL2pZZa8w7cJ0jrbf7Li/Abhs8E6c7Wi11wtJUmzLPEl/uFl2XoKIMC4VWwymwB20JIlvD7QY+BnMB9WkTgYHYtDzwaZfFZqWybnOth2zRstA5kpakpEgZ34IslIDLRrXdjJeZtSiMz7/sgq5RNK7L3xzXTu4D+DiDzylNnOq1urL3qaQeHzMyME2OGvuxit1okR8="
      bucket: eu-west-1-streamr-cdn
      acl: private
      region: eu-west-1
      skip_cleanup: true
      local_dir: docs
      glob: "swagger.json"
      on:
        branch: master
  - stage: Build Docker Production
    if: tag IS present
    install: true
    script:
    - grails prod war
    - docker build -t $OWNER/$IMAGE_NAME:local .
    - .travis_scripts/smoke_test.sh
    deploy:
    - provider: script
      script: .travis_scripts/deploy_docker.sh production
after_failure:
  - docker-compose logs engine-and-editor
  - docker ps
  - .travis_scripts/after_test_failure.sh
